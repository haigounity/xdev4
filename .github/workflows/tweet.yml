name: post-once-daily-at-random-jst-time

on:
  schedule:
    # 毎時0分（UTC）で起動。ジョブ内でJSTの“当たりの時間”でなければ終了。
    - cron: "0 * * * *"
  workflow_dispatch: {}

jobs:
  tweet:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Decide today's random JST hour & minute
        id: when
        shell: bash
        run: |
          # JST日付と現在時刻（時）を取得
          JST_DATE=$(TZ=Asia/Tokyo date +%Y-%m-%d)
          JST_HOUR_NOW=$(TZ=Asia/Tokyo date +%H)

          # その日の疑似乱数を安定生成（リポジトリ名と日付からハッシュ）
          SEED="$(echo "${GITHUB_REPOSITORY}-${JST_DATE}" | sha256sum | cut -c1-8)"

          # 0-23 の“当たりのJST時刻”
          RAND_HOUR=$(( 0x${SEED:0:2} % 24 ))

          # 0-59 の“待機分”を決める（投稿分のランダム化）
          RAND_MIN=$(( 0x${SEED:2:2} % 60 ))

          echo "today=${JST_DATE}" >> $GITHUB_OUTPUT
          echo "now_hour=${JST_HOUR_NOW}" >> $GITHUB_OUTPUT
          echo "rand_hour=${RAND_HOUR}" >> $GITHUB_OUTPUT
          echo "rand_min=${RAND_MIN}" >> $GITHUB_OUTPUT

          # “当たりの時間”でなければスキップ（正常終了）
          if [ "${JST_HOUR_NOW}" -ne "${RAND_HOUR}" ]; then
            echo "Not the chosen hour for today (JST). Skipping."
            exit 0
          fi

      - name: Setup Python
        if: steps.when.outputs.now_hour == steps.when.outputs.rand_hour
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.when.outputs.now_hour == steps.when.outputs.rand_hour
        run: pip install -r requirements.txt

      - name: Wait random minutes within the hour (JST)
        if: steps.when.outputs.now_hour == steps.when.outputs.rand_hour
        shell: bash
        run: |
          SLEEP_MIN=${{ steps.when.outputs.rand_min }}
          echo "Sleeping ${SLEEP_MIN} minutes to randomize the post time in JST hour..."
          sleep $(( SLEEP_MIN * 60 ))

      - name: Run bot
        if: steps.when.outputs.now_hour == steps.when.outputs.rand_hour
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: python post.py
